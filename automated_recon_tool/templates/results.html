<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Recon Report: {{ scan.target }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .badge { padding: 5px 10px; border-radius: 4px; font-size: 0.85em; font-weight: bold; }
        .badge-red { background: #e74c3c; color: white; }
        .badge-green { background: #2ecc71; color: white; }
        .badge-yellow { background: #f1c40f; color: black; }
        
        .data-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .data-table th, .data-table td { border: 1px solid #eee; padding: 10px; text-align: left; }
        .data-table th { background: #f8f9fa; }
        
        .sub-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .screenshot-img { width: 100%; border: 1px solid #ddd; border-radius: 5px; margin-top: 10px; }
        
        .muted-text { color: #95a5a6; font-style: italic; }
    </style>
</head>
<body>
    <div class="container">
        <a href="/" class="back-btn"><i class="fas fa-arrow-left"></i> Dashboard</a>
        
        <header style="margin-bottom: 30px; border-bottom: 2px solid #eee; padding-bottom: 20px;">
            <h1>Target: {{ scan.target }}</h1>
            <div style="font-size: 1.2em; margin-top: 10px;">
                <strong>Risk Assessment:</strong> 
                <span class="badge {{ 'badge-red' if 'High' in scan.impact_summary else 'badge-yellow' if 'Medium' in scan.impact_summary else 'badge-green' }}">
                    {{ scan.impact_summary }}
                </span>
            </div>
            <p style="color: #666; margin-top: 5px;">Scan Date: {{ scan.date_started }}</p>
        </header>

        <div class="sub-grid">
            <div class="result-card">
                <h3><i class="fas fa-server"></i> Network Services</h3>
                {% set nmap = scan.raw_results.get('nmap', {}) %}
                {% if nmap.get('services') %}
                    <table class="data-table">
                        <thead><tr><th>Port</th><th>Proto</th><th>State</th><th>Service</th></tr></thead>
                        <tbody>
                            {% for svc in nmap.services %}
                            <tr>
                                <td><span class="badge badge-yellow">{{ svc.port }}</span></td>
                                <td>{{ svc.protocol }}</td>
                                <td>{{ svc.state }}</td>
                                <td>{{ svc.service }} {% if svc.version %}<small style="color: #666;">({{ svc.version }})</small>{% endif %}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <div style="margin-top:10px;">
                        <a class="action-btn" href="{{ url_for('download_nmap_xml', scan_id=scan.id) }}"><i class="fas fa-download"></i> Download Nmap XML</a>
                        <button class="action-btn" id="toggle-raw" style="margin-left:10px;"><i class="fas fa-code"></i> Toggle raw Nmap JSON</button>
                        <button class="action-btn" id="copy-raw" style="margin-left:6px;"><i class="fas fa-copy"></i> Copy</button>
                    </div>
                    <pre id="raw-json" style="display:none; margin-top:10px; background:#f8f9fa; padding:10px; border-radius:4px; overflow:auto;">{{ nmap | tojson(indent=2) }}</pre>
                {% else %}
                    <p class="muted-text">{{ nmap.get('error') or "No open ports found." }}</p>
                {% endif %}
            </div>

            <div class="result-card">
                <h3><i class="fas fa-envelope-open-text"></i> Email Security</h3>
                {% set dns = scan.raw_results.get('dns_security', {}) %}
                <ul style="list-style: none; padding: 0;">
                    <li>SPF: {{ '✅ Present' if dns.get('spf') else '❌ MISSING' }}</li>
                    <li>DMARC: {{ '✅ Present' if dns.get('dmarc') else '❌ MISSING' }}</li>
                </ul>
            </div>
        </div>

        <div class="sub-grid" style="margin-top: 20px;">
            <div class="result-card">
                <h3><i class="fas fa-shield-virus"></i> Reputation</h3>
                {% set vt = scan.raw_results.get('virustotal', {}) %}
                {% set ip = scan.raw_results.get('ipinfo', {}) %}
                <p><strong>VirusTotal Flags:</strong> {{ vt.get('stats', {}).get('malicious', 0) }}</p>
                <p><strong>Location:</strong> {{ ip.get('loc', 'Unknown') }}</p>
            </div>
            <div class="result-card">
                <h3><i class="fas fa-sitemap"></i> Subdomains</h3>
                {% set crt = scan.raw_results.get('crt_sh', {}) %}
                {% if crt.get('interesting') %}
                    <ul style="padding-left: 20px;">
                        {% for sub in crt.interesting %}
                            <li style="color: #c0392b;">{{ sub }}</li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="muted-text">No interesting subdomains found.</p>
                {% endif %}
            </div>
        </div>

        <div class="sub-grid" style="margin-top: 20px; border-top: 2px dashed #ccc; padding-top: 20px;">
            
            <div class="result-card">
                <h3><i class="fas fa-users"></i> Employee Emails (Hunter)</h3>
                {% set hunter = scan.raw_results.get('hunter', {}) %}
                {% if hunter.get('emails') %}
                    <p><strong>Pattern:</strong> {{ hunter.get('pattern') }}</p>
                    <ul>
                        {% for email in hunter.emails %}
                            <li>{{ email }}</li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="muted-text">{{ hunter.get('error') or "Data unavailable (Old Scan or Missing Key)." }}</p>
                {% endif %}
            </div>

            <div class="result-card">
                <h3><i class="fas fa-eye"></i> Web Analysis (UrlScan)</h3>
                {% set urlscan = scan.raw_results.get('urlscan', {}) %}
                {% if urlscan.get('verdict') is defined %}
                    <p><strong>Malicious:</strong> {{ 'YES' if urlscan.verdict else 'No' }}</p>
                    <p><strong>Server:</strong> {{ urlscan.get('technologies') }}</p>
                    {% if urlscan.get('screenshot') %}
                        <a href="{{ urlscan.screenshot }}" target="_blank">
                            <img src="{{ urlscan.screenshot }}" class="screenshot-img" alt="Screenshot">
                        </a>
                    {% endif %}
                {% else %}
                    <p class="muted-text">{{ urlscan.get('error') or "Data unavailable (Old Scan or Missing Key)." }}</p>
                {% endif %}
            </div>
        </div>

    </div>
    <script>
        (function(){
            const toggleBtn = document.getElementById('toggle-raw');
            const copyBtn = document.getElementById('copy-raw');
            const pre = document.getElementById('raw-json');
            if(toggleBtn && pre){
                toggleBtn.addEventListener('click', () => {
                    pre.style.display = pre.style.display === 'none' ? 'block' : 'none';
                    if(pre.style.display === 'block') pre.scrollIntoView({behavior:'smooth'});
                });
            }
            if(copyBtn && pre){
                copyBtn.addEventListener('click', async () => {
                    try{
                        await navigator.clipboard.writeText(pre.textContent || pre.innerText);
                        copyBtn.textContent = 'Copied!';
                        setTimeout(()=>copyBtn.textContent = 'Copy', 1200);
                    }catch(e){
                        alert('Copy failed.');
                    }
                });
            }
        })();
    </script>
</body>
</html>